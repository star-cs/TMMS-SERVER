<!--
 * @Author: star-cs
 * @Date: 2025-07-27 14:39:54
 * @LastEditTime: 2025-07-27 14:42:10
 * @FilePath: /TMMS-SERVER/tmms/mmedia/README.md
 * @Description: 
-->
# 数据结构
```plaintext
+---------------------------------------+-------------------+-----------------------------+
|          Packet 对象 (固定部分)        |   数据缓冲区 (Data)| RtmpMsgHeader 对象 (独立内存) |
|        (sizeof(Packet) 字节)          |   (size_ 字节)     |   (通过 ext_ 指针共享)        |
+---------------------------------------+-------------------+-----------------------------+
| type_ (4B) | size_ (4B) | index_ (4B) |                   |                             |
| timestamp_ (8B) | capacity_ (4B)      |    实际写入的数据  |  msg_type, cs_id 等字段      |
| ext_ (指针，8B)  [指向 RtmpMsgHeader]  |                   |                             |
+---------------------------------------+-------------------+-----------------------------+
```

# RTMP
## 握手全流程
RTMP（Real-Time Messaging portocol）握手是建立客户端与服务器连接的核心流程，分为简单握手和复杂握手两种模式，主要包含三个阶段、共6个数据包交换（C0/C1/C2 和 S0/S1/S2）。以下是全流程解析及关键技术细节：

阶段1：客户端发起握手（C0 + C1）
1. C0（1字节）  
   • 包含协议版本号（固定为 0x03，表示RTMP版本3）。  
   • 若服务器不支持此版本，返回 S0=0x00 并断开连接。

2. C1（1536字节）  
   • 时间戳（4字节）：客户端发送的当前时间，用于后续同步音视频流。  
   • 随机数据（1528字节）：防重放攻击，确保握手唯一性。  
   • 零填充字段（4字节）：简单握手时固定为0；复杂握手时可能包含密钥位置信息。

⚠️ 实际优化：为减少延迟，客户端常将C0和C1合并发送。

阶段2：服务器响应（S0 + S1 + S2）
1. S0（1字节）  
   • 确认协议版本（通常与C0一致，为 0x03）。

2. S1（1536字节）  
   • 时间戳（4字节）：服务器当前时间，用于客户端同步时序。  
   • 随机数据（1528字节）：若为复杂握手，需验证客户端密钥有效性。

3. S2（1536字节）  
   • 时间戳A（4字节）：回显C1的时间戳（确认收到C1的时间）。  
   • 时间戳B（4字节）：S1的时间戳（供客户端同步服务器时间）。  
   • 随机回显：复制C1中的随机数据。

⚙️ 服务器逻辑：  
- 必须收到C0或C1后才发送S0/S1。  
- S0/S1/S2通常合并发送以优化性能。

阶段3：客户端确认（C2）
• C2（1536字节）  
  • 时间戳A（4字节）：回显S1的时间戳。  
  • 时间戳B（4字节）：C1的时间戳（供服务器同步客户端时间）。  
  • 随机回显：复制S1中的随机数据。  

• 服务器验证C2有效性后，握手完成，开始传输音视频数据。

## 协议头

## 控制消息 / 用户控制消息

## AMF 数据类型
简单类型 / 复杂类型


